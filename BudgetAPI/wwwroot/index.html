<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <title>Budget Manager</title>
    <link href="css/index.css" rel="stylesheet" />
</head>
<body>
    <h1>Budget Manager (Incomes / Outcomes)</h1>

    <div class="section">
        <h2>Total global</h2>
        <button onclick="getTotal('incomes')">Total Incomes</button>
        <button onclick="getTotal('outcomes')">Total Outcomes</button>
        <pre id="total-result"></pre>
    </div>

    <div class="section">
        <h2>Total par mois</h2>
        <label>Année :</label>
        <input type="number" id="year-month" value="2025">
        <label>Mois :</label>
        <input type="number" id="month" value="7">
        <button onclick="getTotalByMonth('incomes')">Incomes</button>
        <button onclick="getTotalByMonth('outcomes')">Outcomes</button>
        <pre id="month-result"></pre>
    </div>

    <div class="section">
        <h2>Total par année</h2>
        <label>Année :</label>
        <input type="number" id="year-total" value="2025">
        <button onclick="getTotalByYear('incomes')">Incomes</button>
        <button onclick="getTotalByYear('outcomes')">Outcomes</button>
        <pre id="year-result"></pre>
    </div>

    <div class="section">
        <h2>Total sur une période</h2>
        <label>De :</label>
        <input type="date" id="start-date">
        <label>À :</label>
        <input type="date" id="end-date">
        <button onclick="getTotalByRange('incomes')">Incomes</button>
        <button onclick="getTotalByRange('outcomes')">Outcomes</button>
        <pre id="range-result"></pre>
    </div>

    <div class="section">
        <h2>Liste des Incomes</h2>
        <button onclick="fetchIncomes()">Charger les incomes</button>
        <table id="income-table">
            <thead>
                <tr><th>ID</th><th>Source</th><th>Amount</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Ajouter / Modifier un Income</h2>
        <label>ID (laisser vide pour ajout) :</label>
        <input type="number" id="income-id">
        <label>Source :</label>
        <input type="text" id="income-source">
        <label>Amount :</label>
        <input type="number" id="income-amount" step="0.01">
        <label>Date :</label>
        <input type="date" id="income-date">
        <button onclick="saveIncome()">Enregistrer</button>
    </div>

    <div class="section">
        <h2>Liste des Outcomes</h2>
        <button onclick="fetchOutcomes()">Charger les outcomes</button>
        <table id="outcome-table">
            <thead>
                <tr><th>ID</th><th>Source</th><th>Amount</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Ajouter / Modifier un Outcome</h2>
        <label>ID (laisser vide pour ajout) :</label>
        <input type="number" id="outcome-id">
        <label>Source :</label>
        <input type="text" id="outcome-source">
        <label>Amount :</label>
        <input type="number" id="outcome-amount" step="0.01">
        <label>Date :</label>
        <input type="date" id="outcome-date">
        <button onclick="saveOutcome()">Enregistrer</button>
    </div>

    <script>
        const API_BASE = "https://localhost:7058/api";
        const token = localStorage.getItem("jwt");

        async function getTotal(type) {
            const res = await fetch(`${API_BASE}/${type}/total`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            const data = await res.text();
            document.getElementById("total-result").textContent = `${type}: ${data}`;
        }

        async function getTotalByMonth(type) {
            const year = document.getElementById("year-month").value;
            const month = document.getElementById("month").value;
            const res = await fetch(`${API_BASE}/${type}/total/month/${year}/${month}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            const data = await res.text();
            document.getElementById("month-result").textContent = `${type} (${month}/${year}): ${data}`;
        }

        async function getTotalByYear(type) {
            const year = document.getElementById("year-total").value;
            const res = await fetch(`${API_BASE}/${type}/total/year/${year}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            const data = await res.text();
            document.getElementById("year-result").textContent = `${type} (${year}): ${data}`;
        }

        async function getTotalByRange(type) {
            const start = document.getElementById("start-date").value;
            const end = document.getElementById("end-date").value;
            const res = await fetch(`${API_BASE}/${type}/total/range`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json", 'Authorization': `Bearer ${token}`,
 },
                body: JSON.stringify({ start, end })
            });
            const data = await res.text();
            document.getElementById("range-result").textContent = `${type} (${start} → ${end}): ${data}`;
        }

        async function fetchIncomes() {
            const res = await fetch(`${API_BASE}/incomes`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            })
            const data = await res.json();
            const tbody = document.querySelector("#income-table tbody");
            tbody.innerHTML = "";
            data.forEach(i => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                                            <td>${i.id}</td>
                                            <td>${i.source}</td>
                                            <td>${i.amount}</td>
                                            <td>${i.dateReceived.split("T")[0]}</td>
                                            <td>
                                                <button onclick="editIncome(${i.id}, '${i.source}', ${i.amount}, '${i.dateReceived.split("T")[0]}')">Modifier</button>
                                                <button onclick="deleteIncome(${i.id})">Supprimer</button>
                                            </td>
                                        `;
                tbody.appendChild(tr);
            });
        }

        function editIncome(id, source, amount, date) {
            document.getElementById("income-id").value = id;
            document.getElementById("income-source").value = source;
            document.getElementById("income-amount").value = amount;
            document.getElementById("income-date").value = date;
        }

        async function deleteIncome(id) {
            if (!confirm("Supprimer cet income ?")) return;
            await fetch(`${API_BASE}/incomes/${id}`, {
                method: "DELETE",
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                } });
            fetchIncomes();
        }

        async function saveIncome() {
            const id = document.getElementById("income-id").value;
            const source = document.getElementById("income-source").value;
            const amount = parseFloat(document.getElementById("income-amount").value);
            const dateReceived = document.getElementById("income-date").value;

            const income = { source, amount, dateReceived };

            if (!id) {
                await fetch(`${API_BASE}/incomes`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(income)
                });
            } else {
                await fetch(`${API_BASE}/incomes/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json", 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ id: parseInt(id), source, amount, dateReceived })
                });
            }
            fetchIncomes();
        }

        async function fetchOutcomes() {
            const res = await fetch(`${API_BASE}/outcomes`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            const data = await res.json();
            const tbody = document.querySelector("#outcome-table tbody");
            tbody.innerHTML = "";
            data.forEach(i => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                                <td>${i.id}</td>
                                <td>${i.source}</td>
                                <td>${i.amount}</td>
                                <td>${i.dateReceived.split("T")[0]}</td>
                                <td>
                                    <button onclick="editOutcome(${i.id}, '${i.source}', ${i.amount}, '${i.dateReceived.split("T")[0]}')">Modifier</button>
                                    <button onclick="deleteOutcome(${i.id})">Supprimer</button>
                                </td>
                            `;
                tbody.appendChild(tr);
            });
        }

        function editOutcome(id, source, amount, date) {
            document.getElementById("outcome-id").value = id;
            document.getElementById("outcome-source").value = source;
            document.getElementById("outcome-amount").value = amount;
            document.getElementById("outcome-date").value = date;
        }

        async function deleteOutcome(id) {
            if (!confirm("Supprimer cet outcome ?")) return;
            await fetch(`${API_BASE}/outcomes/${id}`, {
                method: "DELETE",
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            fetchOutcomes();
        }

        async function saveOutcome() {
            const id = document.getElementById("outcome-id").value;
            const source = document.getElementById("outcome-source").value;
            const amount = parseFloat(document.getElementById("outcome-amount").value);
            const dateReceived = document.getElementById("outcome-date").value;

            const outcome = { source, amount, dateReceived };

            if (!id) {
                await fetch(`${API_BASE}/outcomes`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(outcome)
                });
            } else {
                await fetch(`${API_BASE}/outcomes/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        'Authorization': `Bearer ${token}`,
    },
                    body: JSON.stringify({ id: parseInt(id), source, amount, dateReceived })
                });
            }
            fetchOutcomes();
        }

    </script>

    <div class="section">
        <h2>Graphique Incomes vs Outcomes par mois (2025)</h2>
        <canvas id="budgetChart" width="600" height="300"></canvas>
        <button onclick="loadChartData()">Charger le graphique</button>
    </div>

    <script>
        let chart;

        async function loadChartData() {
            const year = 2025;
            const labels = Array.from({ length: 12 }, (_, i) => `${i + 1}`); // Mois 1 à 12

            const incomeData = await Promise.all(labels.map(async month => {
                const res = await fetch(`${API_BASE}/incomes/total/month/${year}/${month}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                return parseFloat(await res.text());
            }));

            const outcomeData = await Promise.all(labels.map(async month => {
                const res = await fetch(`${API_BASE}/outcomes/total/month/${year}/${month}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                return parseFloat(await res.text());
            }));

            const ctx = document.getElementById('budgetChart').getContext('2d');

            if (chart) chart.destroy(); // Pour éviter les duplications

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(m => `M${m}`),
                    datasets: [
                        {
                            label: 'Incomes',
                            data: incomeData,
                            borderColor: 'green',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Outcomes',
                            data: outcomeData,
                            borderColor: 'red',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Incomes vs Outcomes - Année 2025'
                        }
                    }
                }
            });
        }
    </script>

</body>
</html>
