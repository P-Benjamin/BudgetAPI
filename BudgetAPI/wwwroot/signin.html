<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Budget Manager</title>
    <link href="css/signin.css" rel="stylesheet" />
</head>
<body>
    <h1>Budget Manager</h1>

    <div class="section" id="login-section">
        <h2>Connexion</h2>
        <label>Nom d'utilisateur :</label>
        <input type="text" id="login-username">
        <label>Mot de passe :</label>
        <input type="password" id="login-password">
        <button onclick="login()">Se connecter</button>
        <p>Pas encore de compte ? <a href="#" onclick="show('signup-section')">S'inscrire</a></p>
        <pre id="login-message"></pre>
    </div>

    <div class="section" id="signup-section">
        <h2>Inscription</h2>
        <label>Nom d'utilisateur :</label>
        <input type="text" id="signup-username">
        <label>Mot de passe :</label>
        <input type="password" id="signup-password">
        <label>Email :</label>
        <input type="email" id="signup-email">
        <label>Nom :</label>
        <input type="text" id="signup-surname">
        <label>Prénom :</label>
        <input type="text" id="signup-givenname">
        <label>Rôle :</label>
        <select id="signup-role">
            <option value="User">Utilisateur</option>
            <option value="Administrator">Administrateur</option>
        </select>
        <button onclick="signup()">Créer mon compte</button>
        <p>Déjà inscrit ? <a href="#" onclick="show('login-section')">Se connecter</a></p>
        <pre id="signup-message"></pre>
    </div>

    <div class="section" id="app-section">
        <h2>Bienvenue</h2>
        <p>Jeton JWT stocké !</p>
        <button onclick="logout()">Se déconnecter</button>
        <pre id="jwt-token"></pre>
    </div>

    <script>
        const LOGIN_API = "https://localhost:7058/api/login";
        const SIGNUP_API = "https://localhost:7058/api/users";

        function show(sectionId) {
            ["login-section", "signup-section", "app-section"].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = "none";
            });
            const target = document.getElementById(sectionId);
            if (target) target.style.display = "block";
        }

        function login() {
            const username = document.getElementById("login-username").value;
            const password = document.getElementById("login-password").value;

            fetch(LOGIN_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ userName: username, password })
            })
                .then(async res => {
                    if (!res.ok) throw new Error(await res.text());
                    return res.text();
                })
                .then(token => {
                    localStorage.setItem("jwt", token);
                    document.getElementById("jwt-token").textContent = token;
                    window.location.href = "index.html";
                })
                .catch(err => {
                    document.getElementById("login-message").textContent = "Erreur: " + err.message;
                });
        }

        function signup() {
            const user = {
                username: document.getElementById("signup-username").value,
                password: document.getElementById("signup-password").value,
                emailAddress: document.getElementById("signup-email").value,
                surname: document.getElementById("signup-surname").value,
                givenName: document.getElementById("signup-givenname").value,
                role: document.getElementById("signup-role").value
            };

            fetch(SIGNUP_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(user)
            })
                .then(async res => {
                    if (!res.ok) throw new Error(await res.text());
                    document.getElementById("signup-message").textContent = "Inscription réussie. Connexion en cours...";

                    document.getElementById("login-username").value = user.username;
                    document.getElementById("login-password").value = user.password;

                    login();
                })
                .catch(err => {
                    document.getElementById("signup-message").textContent = "Erreur: " + err.message;
                });
        }

        function logout() {
            localStorage.removeItem("jwt");
            document.getElementById("login-username").value = "";
            document.getElementById("login-password").value = "";
            document.getElementById("jwt-token").textContent = "";
            document.getElementById("login-message").textContent = "";
            show("login-section");
        }

        if (localStorage.getItem("jwt")) {
            document.getElementById("jwt-token").textContent = localStorage.getItem("jwt");
            show("app-section");
        } else {
            show("login-section");
        }
    </script>
</body>
</html>